<!doctype html>
<html lang="zh"><head>
<title>使用 Keycloak REST API 进行身份验证和授权 - Honesty wiki</title>
<meta charset="UTF-8">
<meta name="keywords" content="Honesty 知识库,Honesty Wiki, Honesty blog,hehouhui 知识库,hehouhui Wiki, hehouhui blog">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5">

<link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
<meta name="description" content="启用身份验证和授权涉及复杂的功能，而不仅仅是简单的登录 API。在之前的文章（使用 Keycloak 的 API 登录和 JWT 令牌生成）中，我描述了 Keycloak REST 登录 API 端点，它只处理一些身份验证任务。在本文中，我描述了如何使用开箱即用的 Keycloak REST API 功能启用身份验证和授权的其他方面。 身份验证与授权但首先，身份验证和授权之间有什么区别？简单地说，">
<meta property="og:type" content="article">
<meta property="og:title" content="使用 Keycloak REST API 进行身份验证和授权">
<meta property="og:url" content="https://docs.hehouhui.cn/archives/authentication-and-authorization-using-the-keycloak-rest-api.html">
<meta property="og:site_name" content="Honesty wiki">
<meta property="og:description" content="启用身份验证和授权涉及复杂的功能，而不仅仅是简单的登录 API。在之前的文章（使用 Keycloak 的 API 登录和 JWT 令牌生成）中，我描述了 Keycloak REST 登录 API 端点，它只处理一些身份验证任务。在本文中，我描述了如何使用开箱即用的 Keycloak REST API 功能启用身份验证和授权的其他方面。 身份验证与授权但首先，身份验证和授权之间有什么区别？简单地说，">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://developers.redhat.com/sites/default/files/styles/article_floated/public/blog/2020/08/keycloak-education-00.png?itok=aKKqoLgU">
<meta property="og:image" content="https://developers.redhat.com/sites/default/files/styles/article_floated/public/blog/2020/08/keycloak-education-01.png?itok=TFFotz_T">
<meta property="og:image" content="https://developers.redhat.com/sites/default/files/styles/article_floated/public/blog/2020/08/keycloak-education-06.png?itok=kN1XyC0P">
<meta property="og:image" content="https://developers.redhat.com/sites/default/files/styles/article_floated/public/blog/2020/08/keycloak-education-07.png?itok=KBPu-x5E">
<meta property="og:image" content="https://developers.redhat.com/sites/default/files/styles/article_floated/public/blog/2020/08/keycloak-education-02.png?itok=_XcRiyxZ">
<meta property="og:image" content="https://developers.redhat.com/sites/default/files/styles/article_floated/public/blog/2020/08/keycloak-education-03.png?itok=ioRUgKYl">
<meta property="og:image" content="https://developers.redhat.com/sites/default/files/styles/article_floated/public/blog/2020/08/keycloak-education-04.png?itok=UAhXaIL2">
<meta property="og:image" content="https://developers.redhat.com/sites/default/files/styles/article_floated/public/blog/2020/08/keycloak-education-05.png?itok=bjT_1W98">
<meta property="og:image" content="https://developers.redhat.com/sites/default/files/styles/article_floated/public/blog/2020/08/keycloak-education-11.png?itok=MySy1CkW">
<meta property="og:image" content="https://developers.redhat.com/sites/default/files/styles/article_floated/public/blog/2020/08/keycloak-education-08.png?itok=EQBlb8Yo">
<meta property="og:image" content="https://developers.redhat.com/sites/default/files/styles/article_floated/public/blog/2020/08/keycloak-education-09.png?itok=zZAbM6Sr">
<meta property="og:image" content="https://developers.redhat.com/sites/default/files/styles/article_floated/public/blog/2020/08/keycloak-education-10.png?itok=rOzI0tsb">
<meta property="og:image" content="https://developers.redhat.com/sites/default/files/styles/article_floated/public/blog/2020/08/keycloak-education-12.png?itok=3QIR03u9">
<meta property="og:image" content="https://developers.redhat.com/sites/default/files/styles/article_floated/public/blog/2020/11/keycloak-education-13.png?itok=KkNUCm4W">
<meta property="article:published_time" content="2023-04-28T05:13:00.000Z">
<meta property="article:modified_time" content="2023-10-08T06:42:00.000Z">
<meta property="article:author" content="Honesty">
<meta property="article:tag" content="Java">
<meta property="article:tag" content="开发">
<meta property="article:tag" content="建站">
<meta property="article:tag" content="keycloak">
<meta property="article:tag" content="oauth">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://developers.redhat.com/sites/default/files/styles/article_floated/public/blog/2020/08/keycloak-education-00.png?itok=aKKqoLgU">

<link rel="stylesheet" href="/lib/fancybox/fancybox.css">
<link rel="stylesheet" href="/lib/mdui_043tiny/mdui.css">


<link rel="stylesheet" href="/lib/iconfont/iconfont.css?v=1698751493439">

<link rel="stylesheet" href="/css/style.css?v=1698751493439">




    
        <link rel="stylesheet" href="/custom.css?v=1698751493439">
    



<script src="/lib/mdui_043tiny/mdui.js" async></script>
<script src="/lib/fancybox/fancybox.umd.js" async></script>
<script src="/lib/lax.min.js" async></script>


<script async src="/js/app.js?v=1698751493439"></script>

 

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-248JM4ZRPJ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag("js", new Date());

  gtag("config", "G-248JM4ZRPJ");
</script>

<meta name="generator" content="Hexo 6.3.0"></head><body class="nexmoe mdui-drawer-body-left"><div id="nexmoe-background"><div class="nexmoe-bg" style="background-image: url(https://blog-file.hehouhui.cn/202305111934350.jpeg)"></div><div class="mdui-appbar mdui-shadow-0"><div class="mdui-toolbar"><a class="mdui-btn mdui-btn-icon mdui-ripple" mdui-drawer="{target: &#039;#drawer&#039;, swipe: true}" title="menu"><i class="mdui-icon nexmoefont icon-menu"></i></a><div class="mdui-toolbar-spacer"></div><a class="mdui-btn mdui-btn-icon" href="/" title="Honesty"><img src="https://cdn.jsdelivr.net/gh/listener-He/images@default/202309111525908.jpeg" alt="Honesty"></a></div></div></div><div id="nexmoe-header"><div class="nexmoe-drawer mdui-drawer" id="drawer">
    <div class="nexmoe-avatar mdui-ripple">
        <a href="/" title="Honesty">
            <img src="https://cdn.jsdelivr.net/gh/listener-He/images@default/202309111525908.jpeg" alt="Honesty" alt="Honesty">
        </a>
    </div>
    <div class="nexmoe-count">
        <div><span>文章</span>30</div>
        <div><span>标签</span>33</div>
        <div><span>分类</span>4</div>
    </div>
    <div class="nexmoe-list mdui-list" mdui-collapse="{accordion: true}">
        
        <a class="nexmoe-list-item mdui-list-item mdui-ripple false" href="/" title="回到首页">
            <i class="mdui-list-item-icon nexmoefont icon-home"></i>
            <div class="mdui-list-item-content">
                回到首页
            </div>
        </a>
        
        <a class="nexmoe-list-item mdui-list-item mdui-ripple false" href="/archive.html" title="文章归档">
            <i class="mdui-list-item-icon nexmoefont icon-container"></i>
            <div class="mdui-list-item-content">
                文章归档
            </div>
        </a>
        
        <a class="nexmoe-list-item mdui-list-item mdui-ripple false" href="/PY.html" title="我的朋友">
            <i class="mdui-list-item-icon nexmoefont icon-unorderedlist"></i>
            <div class="mdui-list-item-content">
                我的朋友
            </div>
        </a>
        
        <a class="nexmoe-list-item mdui-list-item mdui-ripple false" href="/donate.html" title="给我赞助">
            <i class="mdui-list-item-icon nexmoefont icon-coffee"></i>
            <div class="mdui-list-item-content">
                给我赞助
            </div>
        </a>
        
        <a class="nexmoe-list-item mdui-list-item mdui-ripple false" href="/about.html" title="关于博主">
            <i class="mdui-list-item-icon nexmoefont icon-info-circle"></i>
            <div class="mdui-list-item-content">
                关于博主
            </div>
        </a>
        
    </div>
    
    
        
        <div class="nexmoe-widget-wrap">
    <div class="nexmoe-widget nexmoe-search">
         
            <form id="search_form" action_e="https://cn.bing.com/search?q=site:hehouhui.cn" onsubmit="return search();">
                <label><input id="search_value" name="q" type="search" placeholder="搜索"></label>
            </form>
         
    </div>
</div>




    
        
        <div class="nexmoe-widget-wrap">
	<div class="nexmoe-widget nexmoe-social">
		<a
			class="mdui-ripple"
			href="https://space.bilibili.com/442038841"
			target="_blank"
			mdui-tooltip="{content: '哔哩哔哩'}"
			style="
				color: rgb(231, 106, 141);
				background-color: rgba(231, 106, 141, .1);
			"
		>
			<i
				class="nexmoefont icon-bilibili"
			></i> </a
		><a
			class="mdui-ripple"
			href="https://github.com/listener-He"
			target="_blank"
			mdui-tooltip="{content: 'GitHub'}"
			style="
				color: rgb(25, 23, 23);
				background-color: rgba(25, 23, 23, .1);
			"
		>
			<i
				class="nexmoefont icon-github"
			></i> </a
		><a
			class="mdui-ripple"
			href="https://www.zhihu.com/people/wen-xin-92-2-57"
			target="_blank"
			mdui-tooltip="{content: '知乎'}"
			style="
				color: rgb(30, 136, 229);
				background-color: rgba(30, 136, 229, .1);
			"
		>
			<i
				class="nexmoefont icon-zhihu"
			></i> </a
		><a
			class="mdui-ripple"
			href="https://twitter.com/Honesty861024"
			target="_blank"
			mdui-tooltip="{content: 'Twitter'}"
			style="
				color: rgb(59, 151, 239);
				background-color: rgba(59, 151, 239, .1);
			"
		>
			<i
				class="nexmoefont icon-twitter"
			></i> </a
		><a
			class="mdui-ripple"
			href="https://docs.hehouhui.cn/atom.xml"
			target="_blank"
			mdui-tooltip="{content: 'RSS'}"
			style="
				color: rgb(247, 132, 34);
				background-color: rgba(247, 132, 34, .1);
			"
		>
			<i
				class="nexmoefont icon-rss"
			></i> </a
		>
	</div>
</div>

    
        
        
  <div class="nexmoe-widget-wrap">
    <h3 class="nexmoe-widget-title">文章分类</h3>
    <div class="nexmoe-widget">

      <ul class="category-list">

        


        

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/创作分享/">创作分享</a>
          <span class="category-list-count">1</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/学习思考/">学习思考</a>
          <span class="category-list-count">3</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/技术分享/">技术分享</a>
          <span class="category-list-count">25</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/碎片杂文/">碎片杂文</a>
          <span class="category-list-count">1</span>
        </li>

        
      </ul>

    </div>
  </div>


    
        
        
  <div class="nexmoe-widget-wrap">
    <div id="randomtagcloud" class="nexmoe-widget tagcloud nexmoe-rainbow">
      <a href="/tags/BUG/" style="font-size: 10px;">BUG</a> <a href="/tags/Java/" style="font-size: 20px;">Java</a> <a href="/tags/Jvm/" style="font-size: 10px;">Jvm</a> <a href="/tags/Python/" style="font-size: 10px;">Python</a> <a href="/tags/Redis/" style="font-size: 15.71px;">Redis</a> <a href="/tags/SAAS/" style="font-size: 10px;">SAAS</a> <a href="/tags/Spring/" style="font-size: 18.57px;">Spring</a> <a href="/tags/WebFlux/" style="font-size: 10px;">WebFlux</a> <a href="/tags/chatgpt/" style="font-size: 10px;">chatgpt</a> <a href="/tags/hutool/" style="font-size: 10px;">hutool</a> <a href="/tags/keycloak/" style="font-size: 11.43px;">keycloak</a> <a href="/tags/mysql/" style="font-size: 10px;">mysql</a> <a href="/tags/notion/" style="font-size: 10px;">notion</a> <a href="/tags/oauth/" style="font-size: 11.43px;">oauth</a> <a href="/tags/%E5%81%A5%E5%BA%B7/" style="font-size: 10px;">健康</a> <a href="/tags/%E5%88%86%E5%B8%83%E5%BC%8F/" style="font-size: 14.29px;">分布式</a> <a href="/tags/%E5%92%96%E5%95%A1/" style="font-size: 10px;">咖啡</a> <a href="/tags/%E5%93%8D%E5%BA%94%E5%BC%8F/" style="font-size: 10px;">响应式</a> <a href="/tags/%E5%9B%BE%E5%83%8F%E5%A4%84%E7%90%86/" style="font-size: 11.43px;">图像处理</a> <a href="/tags/%E5%A4%9A%E7%BA%BF%E7%A8%8B/" style="font-size: 10px;">多线程</a> <a href="/tags/%E5%AD%A6%E4%B9%A0/" style="font-size: 11.43px;">学习</a> <a href="/tags/%E5%B7%A5%E5%85%B7/" style="font-size: 10px;">工具</a> <a href="/tags/%E5%BB%BA%E7%AB%99/" style="font-size: 11.43px;">建站</a> <a href="/tags/%E5%BC%80%E5%8F%91/" style="font-size: 12.86px;">开发</a> <a href="/tags/%E5%BC%82%E6%AD%A5%E7%BC%96%E7%A8%8B/" style="font-size: 11.43px;">异步编程</a> <a href="/tags/%E5%BE%AE%E6%9C%8D%E5%8A%A1/" style="font-size: 17.14px;">微服务</a> <a href="/tags/%E6%80%9D%E8%80%83/" style="font-size: 12.86px;">思考</a> <a href="/tags/%E6%8A%80%E6%9C%AF%E6%B5%81/" style="font-size: 10px;">技术流</a> <a href="/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/" style="font-size: 10px;">数据结构</a> <a href="/tags/%E6%95%B4%E6%B4%BB/" style="font-size: 10px;">整活</a> <a href="/tags/%E6%96%87%E5%AD%97/" style="font-size: 12.86px;">文字</a> <a href="/tags/%E7%89%A9%E8%81%94%E7%BD%91/" style="font-size: 10px;">物联网</a> <a href="/tags/%E7%BC%93%E5%AD%98/" style="font-size: 11.43px;">缓存</a>
    </div>
    
      <script>
        var maxTagcloud = parseInt(17);
        var tags_length = parseInt(33);
        var tags_arr = [];
        for(var i = 0; i < tags_length; i++){
          tags_arr.push(i);
        }
        tags_arr.sort(function (l, r) {
          return Math.random() > 0.5 ? -1 : 1;
        });
        tags_arr = tags_arr.slice(0, maxTagcloud < tags_length ? tags_length - maxTagcloud : 0);
        for(var tag_i = 0; tag_i < tags_arr.length; tag_i++){
          document.getElementById("randomtagcloud").children[tags_arr[tag_i]].style.display = 'none';
        }
      </script>
    
  </div>

    
        
        <!-- 一言 -->
<div class="nexmoe-widget-wrap">
  <h3 class="nexmoe-widget-title">
    一言
  </h3>
  <div class="nexmoe-widget">
    <ul class="hitokoto-box">
      <li id="hitokoto_text_parent" class="hitokoto-text" hitokotoCategory="">
        <a href="#" id="hitokoto_text">
          
        </a>
        <a href="#" id="hitokoto_error_text" style="display: none;">
          
        </a>
      </li>
    </ul>
  </div>
</div>

<script>
  let hitokotoText = document.getElementById('hitokoto_text')
  let hitokotoErroText = document.getElementById('hitokoto_error_text')
  let hitokotoCategory = document.getElementById('hitokoto_text_parent').getAttribute('hitokotoCategory')
  window.addEventListener('load', function () {
    let url = 'https://v1.hitokoto.cn'
    if (hitokotoCategory) {
      url += '?c=' + hitokotoCategory
    }
    fetch(url)
      .then(response => response.json())
      .then(data => {
        hitokotoText.innerText = "「 " + data.hitokoto + " 」 from " + data.from
        hitokotoText.href = 'https://hitokoto.cn/?uuid=' + data.uuid
      })
      .catch((reason) => {
        console.error(11, reason)
        hitokotoText.style.display = 'none'
        hitokotoErroText.style.display = 'block'
      })
  })
</script>
    
        
        
  <div class="nexmoe-widget-wrap">
    <h3 class="nexmoe-widget-title">文章归档</h3>
    <div class="nexmoe-widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/history/2023/">2023</a><span class="archive-list-count">13</span></li><li class="archive-list-item"><a class="archive-list-link" href="/history/2022/">2022</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/history/2021/">2021</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/history/2020/">2020</a><span class="archive-list-count">7</span></li></ul>
    </div>
  </div>



    
        
        
  <div class="nexmoe-widget-wrap">
    <h3 class="nexmoe-widget-title">最新文章</h3>
    <div class="nexmoe-widget">
      <ul>
        
          <li>
            <a href="/archives/spring-boot-tenant-202309.html">Spring Boot 实现多租户架构：支持应用多租户部署和管理</a>
          </li>
        
          <li>
            <a href="/archives/springcloud-data-202309.html">微服务之间的数据依赖问题，该如何解决？</a>
          </li>
        
          <li>
            <a href="/archives/redis-key-202309.html">Redis 热key是什么问题，如何导致的？有什么解决方案？</a>
          </li>
        
          <li>
            <a href="/archives/spring-restclient-2023.html">HttpClient? RestTemplate？WebClient? 不~是 RestClient</a>
          </li>
        
          <li>
            <a href="/archives/lkcoffee-shanghai-coffee-activities-20230602.html">上海咖啡文化周之薅瑞幸羊毛</a>
          </li>
        
      </ul>
    </div>
  </div>

    
        
   
    <div class="nexmoe-copyright">
        &copy; 2023 Honesty
        Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
        & <a href="https://github.com/theme-nexmoe/hexo-theme-nexmoe" target="_blank">Nexmoe</a>
        <br><a target="_blank" href="https://beian.miit.gov.cn/">湘ICP备20014902号</a>
<br><a target="_blank" href="https://www.upyun.com/?utm_source=lianmeng&utm_medium=referral">

    </div>
</div><!-- .nexmoe-drawer --></div><div id="nexmoe-content"><div class="nexmoe-primary"><div class="nexmoe-post">
  <article>
    
        <div class="nexmoe-post-cover"> 
            <img src="https://blog-file.hehouhui.cn/202305111934350.jpeg" alt="使用 Keycloak REST API 进行身份验证和授权" loading="lazy">
            <h1>使用 Keycloak REST API 进行身份验证和授权</h1>
        </div>
    
    
    <div class="nexmoe-post-meta">
    <div class="nexmoe-rainbow">
        <a class="nexmoefont icon-calendar-fill">2023年04月28日</a>
        
            <a class="nexmoefont icon-appstore-fill -link" href="/categories/%E6%8A%80%E6%9C%AF%E5%88%86%E4%BA%AB/">技术分享</a>
        
        
    </div>
    
    
    
    
    
</div>

    <p>启用身份验证和授权涉及复杂的功能，而不仅仅是简单的登录 API。<a target="_blank" rel="noopener" href="https://blog.hehouhui.cn/archives/api-login-and-jwt-token-generation-using-keycloak">在之前的文章（使用 Keycloak 的 API 登录和 JWT 令牌生成）中</a>，我描述了 Keycloak REST 登录 API 端点，它只处理一些身份验证任务。在本文中，我描述了如何使用开箱即用的 Keycloak REST API 功能启用身份验证和授权的其他方面。</p>
<h1 id="身份验证与授权"><a href="#身份验证与授权" class="headerlink" title="身份验证与授权"></a>身份验证与授权</h1><p>但首先，身份验证和授权之间有什么区别？简单地说，身份验证意味着<em>你是谁</em>，而授权意味着<em>你可以做什么</em>，每种方法都使用不同的方法进行验证。例如，身份验证使用用户管理和登录表单，授权使用基于角色的访问控制 (RBAC) 或访问控制列表 (ACL)。幸运的是，这些验证方法在 Red Hat 的单点登录 (SSO) 工具中提供，或者在他们的上游开源项目 Keycloak 的 REST API 中提供。</p>
<h1 id="Keycloak-SSO-案例研究"><a href="#Keycloak-SSO-案例研究" class="headerlink" title="Keycloak SSO 案例研究"></a>Keycloak SSO 案例研究</h1><p>为了更好地理解使用 Keycloak 进行身份验证和授权，让我们从一个简单的案例研究开始。假设印度尼西亚教育部计划创建与多所学校的单点登录集成。他们计划使用集中式平台在多个学校维护学生和教师的单一帐户 ID。这让每个用户都具有相同的角色，但在每所学校具有不同的访问权限和特权，如图 1 所示。</p>
<p><img src="https://developers.redhat.com/sites/default/files/styles/article_floated/public/blog/2020/08/keycloak-education-00.png?itok=aKKqoLgU"></p>
<p>图 1：每个用户都可以使用相同的角色，但在每所学校具有不同的访问权限和权限。”&gt;</p>
<h1 id="Keycloak-SSO-演示"><a href="#Keycloak-SSO-演示" class="headerlink" title="Keycloak SSO 演示"></a>Keycloak SSO 演示</h1><p>让我们通过创建一个 Keycloak 领域来开始演示。为该部门使用 Add realm 对话框（如图 2 所示）。为领域命名<code>education</code>，将<strong>Enabled</strong>设置为<strong>ON</strong>，然后单击<strong>Create</strong>。</p>
<p><img src="https://developers.redhat.com/sites/default/files/styles/article_floated/public/blog/2020/08/keycloak-education-01.png?itok=TFFotz_T"></p>
<p>图 2：为教育部创建名为“教育”的 Keycloak 领域。”&gt;</p>
<p>接下来，转到 Roles 页面并确保选择了<strong>Realm Roles</strong>选项卡，如图 3 所示。</p>
<p><img src="https://developers.redhat.com/sites/default/files/styles/article_floated/public/blog/2020/08/keycloak-education-06.png?itok=kN1XyC0P"></p>
<p>图 3：为教育领域创建两个独立的角色：教师和学生。</p>
<p>单击<strong>添加角色</strong>为该领域创建两个单独的角色，称为“教师”和“学生”。然后，这些新角色将出现在<strong>Realm Roles</strong>选项卡中，如图 4 所示。</p>
<p><img src="https://developers.redhat.com/sites/default/files/styles/article_floated/public/blog/2020/08/keycloak-education-07.png?itok=KBPu-x5E"></p>
<p>图 4：添加教师和学生角色。”&gt;</p>
<p>然后，使用 Clients 页面，单击<strong>Create</strong>添加客户端，如图 5 所示。</p>
<p><img src="https://developers.redhat.com/sites/default/files/styles/article_floated/public/blog/2020/08/keycloak-education-02.png?itok=_XcRiyxZ"></p>
<p>图 5：添加客户端。</p>
<p>在 Add Client 页面上，创建一个名为“jakarta-school”的客户端，然后单击<strong>Save</strong>添加该客户端，如图 6 所示。</p>
<p><img src="https://developers.redhat.com/sites/default/files/styles/article_floated/public/blog/2020/08/keycloak-education-03.png?itok=ioRUgKYl"></p>
<p>在 jakarta-school 详细信息页面上，转到<strong>“设置”</strong>选项卡并输入以下客户端配置，如图 7 所示：</p>
<ul>
<li><p><strong>客户 ID</strong></p>
<p>: jakarta-school</p>
</li>
<li><p><strong>启用</strong></p>
<p>：开</p>
</li>
<li><p><strong>需要同意</strong></p>
<p>：关闭</p>
</li>
<li><p><strong>客户端协议</strong></p>
<p>：openid-connect</p>
</li>
<li><p><strong>访问类型</strong></p>
<p>：机密</p>
</li>
<li><p><strong>启用标准流量</strong></p>
<p>：开</p>
</li>
<li><p><strong>启用影响流</strong></p>
<p>：关闭</p>
</li>
<li><p><strong>已启用直接访问授权</strong></p>
<p>：ON</p>
</li>
</ul>
<p><img src="https://developers.redhat.com/sites/default/files/styles/article_floated/public/blog/2020/08/keycloak-education-04.png?itok=UAhXaIL2"></p>
<p>图 7：在 jakarta-school 详细信息页面上，输入客户端配置。</p>
<p>在同一页面的底部，在 Authentication Flow Overrides 部分，我们可以设置如下，如图 8 所示：</p>
<ul>
<li><p><strong>浏览器流程</strong></p>
<p>：浏览器</p>
</li>
<li><p><strong>直接拨款流程</strong></p>
<p>：直接拨款</p>
</li>
</ul>
<p><img src="https://developers.redhat.com/sites/default/files/styles/article_floated/public/blog/2020/08/keycloak-education-05.png?itok=bjT_1W98"></p>
<p>图 8：配置身份验证流程覆盖。”&gt;</p>
<p>转到<strong>Roles</strong>选项卡，单击<strong>Add Role</strong>，然后为此客户端创建 create-student-grade、view-student-grade 和 view-student-profile 角色，如图 9 所示。每个角色都应设置为 Composite <strong>False</strong>。</p>
<p><img src="https://developers.redhat.com/sites/default/files/styles/article_floated/public/blog/2020/08/keycloak-education-11.png?itok=MySy1CkW"></p>
<p>图 9：为此客户创建角色。</p>
<p>接下来，转到<strong>Client Scopes</strong>选项卡，在<strong>Default Client Scopes</strong>部分中，将“roles”和“profile”添加到<strong>Assigned Default Client Scopes</strong>中，如图 10 所示。</p>
<p><img src="https://developers.redhat.com/sites/default/files/styles/article_floated/public/blog/2020/08/keycloak-education-08.png?itok=EQBlb8Yo"></p>
<p>图 10：设置客户端范围。</p>
<p>在 jakarta-school 详情页面，选择<strong>Mappers</strong>，然后选择<strong>Create Protocol Mappers</strong>，设置 mappers 在 Userinfo API 上显示客户端角色，如图 11 所示：</p>
<ul>
<li><p><strong>名称</strong></p>
<p>：角色</p>
</li>
<li><p><strong>映射器类型</strong></p>
<p>：用户领域角色</p>
</li>
<li><p><strong>多值</strong></p>
<p>：开</p>
</li>
<li><p><strong>令牌声明名称</strong></p>
<p>：角色</p>
</li>
<li><p><strong>声明 JSON 类型</strong></p>
<p>：字符串</p>
</li>
<li><p><strong>添加到 ID 令牌</strong></p>
<p>：关闭</p>
</li>
<li><p><strong>添加到访问令牌</strong></p>
<p>：关闭</p>
</li>
<li><p><strong>添加到用户信息</strong></p>
<p>：ON</p>
</li>
</ul>
<p><img src="https://developers.redhat.com/sites/default/files/styles/article_floated/public/blog/2020/08/keycloak-education-09.png?itok=zZAbM6Sr"></p>
<p>图 11：设置映射器以显示客户端角色。</p>
<p>接下来，转到<strong>Users</strong>页面，选择<strong>Add user</strong>，创建新用户，然后单击<strong>Save，</strong>如图 12 所示：</p>
<ul>
<li><p><strong>用户名</strong></p>
<p>：埃德温</p>
</li>
<li><p><strong>电子邮件</strong></p>
<p>：<a href="mailto:&#101;&#100;&#119;&#x69;&#x6e;&#64;&#114;&#101;&#x64;&#104;&#97;&#x74;&#x2e;&#x63;&#111;&#109;">&#101;&#100;&#119;&#x69;&#x6e;&#64;&#114;&#101;&#x64;&#104;&#97;&#x74;&#x2e;&#x63;&#111;&#109;</a></p>
</li>
<li><p><strong>名字</strong></p>
<p>：埃德温</p>
</li>
<li><p><strong>姓</strong></p>
<p>: M</p>
</li>
<li><p><strong>用户启用</strong></p>
<p>：ON</p>
</li>
<li><p><strong>电子邮件已验证</strong></p>
<p>：关闭</p>
</li>
</ul>
<p><img src="https://developers.redhat.com/sites/default/files/styles/article_floated/public/blog/2020/08/keycloak-education-10.png?itok=rOzI0tsb"></p>
<p>图 12：创建新用户。</p>
<p>最后，在<strong>Role Mappings</strong>选项卡中，为 jakarta-school 中的每个用户选择<strong>Client Roles</strong>，如图 13 所示。它们应该是 create-student-grade、view-student-grade 和 view-student-profile。</p>
<p><img src="https://developers.redhat.com/sites/default/files/styles/article_floated/public/blog/2020/08/keycloak-education-12.png?itok=3QIR03u9"></p>
<p>图 13：为 jakarta-school 中的每个用户选择客户端角色。</p>
<p>我的 Keycloak 配置演示到此结束。</p>
<h1 id="使用-Java-应用程序的-Keycloak-连接"><a href="#使用-Java-应用程序的-Keycloak-连接" class="headerlink" title="使用 Java 应用程序的 Keycloak 连接"></a>使用 Java 应用程序的 Keycloak 连接</h1><p>现在我想演示如何开发一个非常简单的 Java 应用程序。此应用程序连接到您的 Keycloak 实例，并通过其 REST API 使用 Keycloak 的身份验证和授权功能。</p>
<p>首先，从 pom.xml 文件开始开发 Java 应用程序，如以下示例所示：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>EducationService<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>com.edw<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.2.1.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">relativePath</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">java.version</span>&gt;</span>11<span class="tag">&lt;/<span class="name">java.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.auth0<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jwks-rsa<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.12.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.auth0<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>java-jwt<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.8.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>Java 应用程序还要求您开发一个简单的属性文件：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">error:</span></span><br><span class="line">    <span class="attr">whitelabel:</span> <span class="string">enabled:false</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8082</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">mvc:</span></span><br><span class="line">    <span class="attr">favicon:</span> <span class="string">enabled:false</span></span><br><span class="line"><span class="attr">keycloak:</span></span><br><span class="line">  <span class="attr">client-id:</span> <span class="string">jakarta-school</span></span><br><span class="line">  <span class="attr">client-secret:</span> <span class="string">197bc3b4-64b0-452f-9bdb-fcaea0988e90</span></span><br><span class="line">  <span class="attr">scope:</span> <span class="string">openid,</span> <span class="string">profile</span></span><br><span class="line">  <span class="attr">authorization-grant-type:</span> <span class="string">password</span></span><br><span class="line">  <span class="attr">authorization-uri:</span> <span class="string">http://localhost:8080/auth/realms/education/protocol/openid-connect/auth</span></span><br><span class="line">  <span class="attr">user-info-uri:</span> <span class="string">http://localhost:8080/auth/realms/education/protocol/openid-connect/userinfo</span></span><br><span class="line">  <span class="attr">token-uri:</span> <span class="string">http://localhost:8080/auth/realms/education/protocol/openid-connect/token</span></span><br><span class="line">  <span class="attr">logout:</span> <span class="string">http://localhost:8080/auth/realms/education/protocol/openid-connect/logout</span></span><br><span class="line">  <span class="attr">jwk-set-uri:</span> <span class="string">http://localhost:8080/auth/realms/education/protocol/openid-connect/certs</span></span><br><span class="line">  <span class="attr">certs-id:</span> <span class="string">vdaec4Br3ZnRFtZN-pimK9v1eGd3gL2MHu8rQ6M5SiE</span></span><br><span class="line"><span class="attr">logging:</span></span><br><span class="line">  <span class="attr">level:</span></span><br><span class="line">    <span class="attr">root:</span> <span class="string">INFO</span></span><br></pre></td></tr></table></figure>

<p>接下来，从图 14 所示的表单中获取 Keycloak 证书 ID。</p>
<p><img src="https://developers.redhat.com/sites/default/files/styles/article_floated/public/blog/2020/11/keycloak-education-13.png?itok=KkNUCm4W"></p>
<p>图 14：找到 Keycloak 证书 ID。</p>
<p>之后，最重要的是，您的下一个任务是开发集成代码；此操作涉及多个 Keycloak API。请注意，我没有详细介绍 Keycloak 登录 API，因为它已经在我之前的文章中进行了描述。</p>
<p>从一个简单的注销 API 开始：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Value(&quot;$&#123;keycloak.logout&#125;&quot;)</span></span><br><span class="line"><span class="keyword">private</span> String keycloakLogout;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">logout</span><span class="params">(String refreshToken)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    MultiValueMap&lt;String, String&gt; map = <span class="keyword">new</span> <span class="title class_">LinkedMultiValueMap</span>&lt;&gt;();</span><br><span class="line">    map.add(<span class="string">&quot;client_id&quot;</span>,clientId);</span><br><span class="line">    map.add(<span class="string">&quot;client_secret&quot;</span>,clientSecret);</span><br><span class="line">    map.add(<span class="string">&quot;refresh_token&quot;</span>,refreshToken);</span><br><span class="line"></span><br><span class="line">    HttpEntity&lt;MultiValueMap&lt;String, String&gt;&gt; request = <span class="keyword">new</span> <span class="title class_">HttpEntity</span>&lt;&gt;(map, <span class="literal">null</span>);</span><br><span class="line">    restTemplate.postForObject(keycloakLogout, request, String.class);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>首先，我想指出，对于注销，使用参数<code>refresh_token</code>而不是是至关重要的<code>access_token</code>。现在，使用 API 检查不记名令牌是否有效和活跃，以验证请求是否带来有效凭证。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Value(&quot;$&#123;keycloak.user-info-uri&#125;&quot;)</span></span><br><span class="line"><span class="keyword">private</span> String keycloakUserInfo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> String <span class="title function_">getUserInfo</span><span class="params">(String token)</span> &#123;</span><br><span class="line">    MultiValueMap&lt;String, String&gt; headers = <span class="keyword">new</span> <span class="title class_">LinkedMultiValueMap</span>&lt;&gt;();</span><br><span class="line">    headers.add(<span class="string">&quot;Authorization&quot;</span>, token);</span><br><span class="line"></span><br><span class="line">    HttpEntity&lt;MultiValueMap&lt;String, String&gt;&gt; request = <span class="keyword">new</span> <span class="title class_">HttpEntity</span>&lt;&gt;(<span class="literal">null</span>, headers);</span><br><span class="line">    <span class="keyword">return</span> restTemplate.postForObject(keycloakUserInfo, request, String.class);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>对于授权，您可以使用两种方法来决定给定角色是否有资格访问特定 API。第一种方法是通过针对 Keycloak 的 userinfo API 进行验证来确定不记名令牌带来的角色，下一个方法是验证不记名令牌中的角色。</p>
<p>对于第一种方法，您可以期待 Keycloak 的以下响应：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;sub&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ef2cbe43-9748-40e5-aed9-fe981e3082d5&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;roles&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;teacher&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Edwin M&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;preferred_username&quot;</span><span class="punctuation">:</span> <span class="string">&quot;edwin&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;given_name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Edwin &quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;family_name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;M&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>如您所见，那里有一个<code>roles</code>标签，一种方法是根据它来验证访问权限。缺点是每个请求在您的应用程序和 Keycloak 之间有多次往返请求，这会导致更高的延迟。</p>
<p>另一种方法是读取通过每个请求发送的 JWT 令牌的内容。为了成功解码您的 JWT 令牌，您必须知道用于对其签名的公钥。这就是 Keycloak 提供 JWKS 端点的原因。您可以使用 curl 命令查看其内容，如以下示例所示：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;keys&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;kid&quot;</span><span class="punctuation">:</span> <span class="string">&quot;vdaec4Br3ZnRFtZN-pimK9v1eGd3gL2MHu8rQ6M5SiE&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;kty&quot;</span><span class="punctuation">:</span> <span class="string">&quot;RSA&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;alg&quot;</span><span class="punctuation">:</span> <span class="string">&quot;RS256&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;use&quot;</span><span class="punctuation">:</span> <span class="string">&quot;sig&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;n&quot;</span><span class="punctuation">:</span> <span class="string">&quot;4OPCc_LDhU6ADQj7cEgRei4VUf4PZH8GYsxsR6RSdeKmDvZ48hCSEFiEgfc3FIfh-gC4r9PtKucc_nkRofrAKR4qL8KNNoSuzQAOC92Yz6r7Ao4HppHJ8-QVdo5H-d9wfNSlDLBSo5My4b4EnHb1HLuFxDqyhFpGvsoUJdgbt3m_Q3WAVb2yrM83S6HX__vrQvqUk2e7z5RNrI7LSsW3ZOz9fU7pvm8-kFFAIPJ7fOJIC7UQ9wBWg3YdwQ0B2b24jXjVr0QCGzqJ6o1G_UZYSJCDMGQDpDcEuYnvSKBLfVR-0EcAjolRhcSPjHlW0Cp0YU8qwWDHpjkbrMrFmxlO4Q&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;e&quot;</span><span class="punctuation">:</span> <span class="string">&quot;AQAB&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>请注意，在前面的示例中，kid 代表 key id，alg 代表加密算法，n 代表用于此领域的公钥。您可以使用此公钥轻松解码我们的 JWT 令牌，并从 JWT 声明中读取 roles。下面显示了解码后的样本 JWT 令牌：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;jti&quot;</span><span class="punctuation">:</span> <span class="string">&quot;85edca8c-a4a6-4a4c-b8c0-356043e7ba7d&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;exp&quot;</span><span class="punctuation">:</span> <span class="number">1598079154</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;nbf&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;iat&quot;</span><span class="punctuation">:</span> <span class="number">1598078854</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;iss&quot;</span><span class="punctuation">:</span> <span class="string">&quot;http://localhost:8080/auth/realms/education&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;sub&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ef2cbe43-9748-40e5-aed9-fe981e3082d5&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;typ&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Bearer&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;azp&quot;</span><span class="punctuation">:</span> <span class="string">&quot;jakarta-school&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;auth_time&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;session_state&quot;</span><span class="punctuation">:</span> <span class="string">&quot;f8ab78f8-15ee-403d-8db7-7052a8647c65&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;acr&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;realm_access&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;roles&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;teacher&quot;</span><span class="punctuation">]</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;resource_access&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;jakarta-school&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;roles&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="string">&quot;create-student-grade&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="string">&quot;view-student-profile&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="string">&quot;view-student-grade&quot;</span></span><br><span class="line">      <span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;scope&quot;</span><span class="punctuation">:</span> <span class="string">&quot;profile&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Edwin M&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;preferred_username&quot;</span><span class="punctuation">:</span> <span class="string">&quot;edwin&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;given_name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Edwin&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;family_name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;M&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>您可以使用以下示例中显示的代码读取角色标签：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/teacher&quot;)</span></span><br><span class="line"> <span class="keyword">public</span> HashMap <span class="title function_">teacher</span><span class="params">(<span class="meta">@RequestHeader(&quot;Authorization&quot;)</span> String authHeader)</span> &#123;</span><br><span class="line">     <span class="keyword">try</span> &#123;</span><br><span class="line">         <span class="type">DecodedJWT</span> <span class="variable">jwt</span> <span class="operator">=</span> JWT.decode(authHeader.replace(<span class="string">&quot;Bearer&quot;</span>, <span class="string">&quot;&quot;</span>).trim());</span><br><span class="line"></span><br><span class="line">         <span class="comment">// check JWT is valid</span></span><br><span class="line">         <span class="type">Jwk</span> <span class="variable">jwk</span> <span class="operator">=</span> jwtService.getJwk();</span><br><span class="line">         <span class="type">Algorithm</span> <span class="variable">algorithm</span> <span class="operator">=</span> Algorithm.RSA256((RSAPublicKey) jwk.getPublicKey(), <span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">         algorithm.verify(jwt);</span><br><span class="line"></span><br><span class="line">         <span class="comment">// check JWT role is correct</span></span><br><span class="line">         List&lt;String&gt; roles = ((List)jwt.getClaim(<span class="string">&quot;realm_access&quot;</span>).asMap().get(<span class="string">&quot;roles&quot;</span>));</span><br><span class="line">         <span class="keyword">if</span>(!roles.contains(<span class="string">&quot;teacher&quot;</span>))</span><br><span class="line">             <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Exception</span>(<span class="string">&quot;not a teacher role&quot;</span>);</span><br><span class="line"></span><br><span class="line">         <span class="comment">// check JWT is still active</span></span><br><span class="line">         <span class="type">Date</span> <span class="variable">expiryDate</span> <span class="operator">=</span> jwt.getExpiresAt();</span><br><span class="line">         <span class="keyword">if</span>(expiryDate.before(<span class="keyword">new</span> <span class="title class_">Date</span>()))</span><br><span class="line">             <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Exception</span>(<span class="string">&quot;token is expired&quot;</span>);</span><br><span class="line"></span><br><span class="line">         <span class="comment">// all validation passed</span></span><br><span class="line">         <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>() &#123;&#123;</span><br><span class="line">             put(<span class="string">&quot;role&quot;</span>, <span class="string">&quot;teacher&quot;</span>);</span><br><span class="line">         &#125;&#125;;</span><br><span class="line">     &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">         logger.error(<span class="string">&quot;exception : &#123;&#125; &quot;</span>, e.getMessage());</span><br><span class="line">         <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>() &#123;&#123;</span><br><span class="line">             put(<span class="string">&quot;status&quot;</span>, <span class="string">&quot;forbidden&quot;</span>);</span><br><span class="line">         &#125;&#125;;</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<p>这种方法最好的部分是您可以将来自 Keycloak 的公钥放在缓存中，从而减少往返请求，这种做法最终会增加应用程序延迟和性能。<a target="_blank" rel="noopener" href="https://github.com/edwin/java-keycloak-integration">可以在我的 GitHub 存储库中</a>找到本文的完整代码。</p>
<h1 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h1><p>总之，我准备这篇文章首先是为了解释启用身份验证和授权涉及复杂的功能，而不仅仅是一个简单的登录 API。然后我演示了如何使用开箱即用的 Keycloak REST API 功能启用身份验证和授权的许多方面。</p>
<p>此外，我还演示了如何开发一个连接到您的 Keycloak 实例的简单 Java 应用程序，并通过其 REST API 使用 Keycloak 的身份验证和授权功能。</p>

    <p><img src="https://i.dawnlab.me/53a8c7cf3ad77a0f0a456ce2c6afe88a.png" loading="lazy"></p>

  </article>

  
      
    <div class="nexmoe-post-copyright">
        <strong>本文作者：</strong>Honesty<br>
        <strong>本文链接：</strong><a href="https://docs.hehouhui.cn/archives/authentication-and-authorization-using-the-keycloak-rest-api.html" title="https:&#x2F;&#x2F;docs.hehouhui.cn&#x2F;archives&#x2F;authentication-and-authorization-using-the-keycloak-rest-api.html" target="_blank" rel="noopener">https:&#x2F;&#x2F;docs.hehouhui.cn&#x2F;archives&#x2F;authentication-and-authorization-using-the-keycloak-rest-api.html</a><br>
        
            <strong>版权声明：</strong>本文采用 <a href="https://creativecommons.org/licenses/by-nc-sa/3.0/cn/deed.zh" target="_blank">CC BY-NC-SA 3.0 CN</a> 协议进行许可

        
    </div>


  
  
  <div class="nexmoe-post-meta nexmoe-rainbow">
   
    
        <a class="nexmoefont icon-tag-fill -none-link" href="/tags/Java/" rel="tag">Java</a> <a class="nexmoefont icon-tag-fill -none-link" href="/tags/keycloak/" rel="tag">keycloak</a> <a class="nexmoefont icon-tag-fill -none-link" href="/tags/oauth/" rel="tag">oauth</a> <a class="nexmoefont icon-tag-fill -none-link" href="/tags/%E5%BB%BA%E7%AB%99/" rel="tag">建站</a> <a class="nexmoefont icon-tag-fill -none-link" href="/tags/%E5%BC%80%E5%8F%91/" rel="tag">开发</a>
    
</div>
  
  
    <script async src="/js/copy-codeblock.js?v=1698751493233"></script>
  

  
      <div class="nexmoe-post-footer">
          <script src="https://giscus.app/client.js"
       data-repo="listener-He/NotionNext"
       data-repo-id="R_kgDOJI1XUA"
       data-category="General"
       data-category-id="R_kgDOJOsY1g"
       data-mapping="pathname"
       data-strict="0"
       data-reactions-enabled="1"
       data-emit-metadata="0"
       data-input-position="top"
       data-theme="preferred_color_scheme"
       data-lang="zh-CN"
       data-loading="lazy"
       crossorigin="anonymous"
       async>
 </script>

      </div>
  
</div></div><div class="nexmoe-post-right">    <div class="nexmoe-fixed">
        <div class="nexmoe-tool">

            

            
            
            <button class="mdui-fab catalog" style="overflow:unset;">
                <i class="nexmoefont icon-i-catalog"></i>
                <div class="nexmoe-toc">
                    <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%BA%AB%E4%BB%BD%E9%AA%8C%E8%AF%81%E4%B8%8E%E6%8E%88%E6%9D%83"><span class="toc-number">1.</span> <span class="toc-text">身份验证与授权</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Keycloak-SSO-%E6%A1%88%E4%BE%8B%E7%A0%94%E7%A9%B6"><span class="toc-number">2.</span> <span class="toc-text">Keycloak SSO 案例研究</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Keycloak-SSO-%E6%BC%94%E7%A4%BA"><span class="toc-number">3.</span> <span class="toc-text">Keycloak SSO 演示</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-Java-%E5%BA%94%E7%94%A8%E7%A8%8B%E5%BA%8F%E7%9A%84-Keycloak-%E8%BF%9E%E6%8E%A5"><span class="toc-number">4.</span> <span class="toc-text">使用 Java 应用程序的 Keycloak 连接</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%BB%93%E8%AE%BA"><span class="toc-number">5.</span> <span class="toc-text">结论</span></a></li></ol>
                </div>
            </button>
            

            

            <a href="#nexmoe-content" class="backtop toc-link" aria-label="Back To Top" title="top"><button class="mdui-fab mdui-ripple"><i class="nexmoefont icon-caret-top"></i></button></a>
        </div>
    </div>
</div></div><div id="nexmoe-footer"><!--!--></div><div><div id="nexmoe-search-space">
	<div class="search-container">
		<div class="search-header">
			<div class="search-input-container">
				<input
					class="search-input"
					type="text"
					placeholder="搜索"
					oninput="sinput();"
				/>
			</div>
			<a class="search-close" onclick="sclose();">×</a>
		</div>
		<div class="search-body"></div>
	</div>
</div>
</div><div><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1623991949842711" crossorigin="anonymous"></script>
</div></body></html>